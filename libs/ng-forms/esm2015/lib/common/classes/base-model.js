import { validate } from '@webblocksapp/class-validator';
import { BehaviorSubject } from 'rxjs';
export class BaseModel {
    constructor(DtoClass) {
        this.errors = [];
        this.map = [];
        this.submitted = false;
        this.resetTimes = new BehaviorSubject(0);
        this.setDto(DtoClass);
    }
    setDto(DtoClass) {
        this.dtoObject = new DtoClass();
    }
    incrementResetTimes() {
        const currentValue = this.resetTimes.getValue();
        this.resetTimes.next(currentValue + 1);
    }
    resetDto() {
        const keys = Object.keys(this.dtoObject);
        keys.forEach((key) => {
            this.dtoObject[key] = null;
        });
    }
    getResetTimes() {
        return this.resetTimes;
    }
    getDto() {
        return this.dtoObject;
    }
    setValue(key, value) {
        this.dtoObject[key] = value || null;
    }
    getValue(key) {
        return this.dtoObject[key];
    }
    setSubmitted(flag) {
        this.submitted = flag;
    }
    getSubmitted() {
        return this.submitted;
    }
    setErrors(errors) {
        this.errors = Object.assign(this.errors, errors);
    }
    initMap() {
        const keys = Object.keys(this.dtoObject);
        keys.forEach((key) => {
            const filteredMap = this.map.filter((item) => item.property === key);
            if (filteredMap.length === 0) {
                this.map.push({ property: key, touched: false });
            }
        });
    }
    resetMap() {
        this.map = [];
        this.initMap();
    }
    setTouched(property = null, touched = true) {
        if (property) {
            this.map.map((item) => {
                if (item.property === property) {
                    item.touched = touched;
                }
            });
        }
        else {
            this.map.map((item) => {
                item.touched = touched;
            });
        }
    }
    cleanError(fieldName) {
        this.errors = this.errors.filter((error) => error.property !== fieldName);
    }
    cleanErrors() {
        this.errors = [];
    }
    getErrors() {
        return this.errors;
    }
    getMap() {
        return this.map;
    }
    getPropertyMap(property) {
        const filteredMap = this.map.filter((item) => item.property === property);
        if (filteredMap.length > 0) {
            return filteredMap[0];
        }
        return null;
    }
    fill(data) {
        const objectKeys = Object.keys(data);
        objectKeys.forEach((key) => {
            const value = data[key];
            this.setValue(key, value);
        });
    }
    validate(validatorOptions) {
        return new Promise((resolve) => {
            validatorOptions = Object.assign({
                propertyName: undefined,
                stopAtFirstError: true,
            }, validatorOptions);
            validate(this.dtoObject, validatorOptions).then((errors) => {
                if (errors.length === 0) {
                    this.cleanErrors();
                    resolve({
                        isValid: true,
                        validatedData: this.dtoObject,
                        errors: null,
                    });
                }
                if (errors.length > 0) {
                    this.setErrors(errors);
                    resolve({ isValid: false, validatedData: null, errors });
                }
                this.setTouched();
            });
        });
    }
    validateField(fieldName, validatorOptions) {
        return new Promise((resolve, reject) => {
            validatorOptions = Object.assign({
                propertyName: fieldName,
                stopAtFirstError: true,
            }, validatorOptions);
            validate(this.dtoObject, validatorOptions).then((errors) => {
                if (errors.length === 0) {
                    this.cleanError(fieldName);
                    resolve(this.dtoObject[fieldName]);
                }
                if (errors.length > 0) {
                    this.setErrors(errors);
                    reject(errors);
                }
                this.setTouched(fieldName);
            });
        });
    }
    reset() {
        this.cleanErrors();
        this.setSubmitted(false);
        this.resetDto();
        this.resetMap();
        this.incrementResetTimes();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiIvVm9sdW1lcy9EYXRvcyBNYXVyby9Eb2N1bWVudG9zL0Rlc2Fycm9sbG9zIFdlYi9Bbmd1bGFyIGxpYnMvYW5ndWxhci1icy1mb3JtLWNvbXBvbmVudHMvcHJvamVjdHMvbmctZm9ybXMvc3JjLyIsInNvdXJjZXMiOlsibGliL2NvbW1vbi9jbGFzc2VzL2Jhc2UtbW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBbUIsTUFBTSwrQkFBK0IsQ0FBQztBQUUxRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXZDLE1BQU0sT0FBTyxTQUFTO0lBT3BCLFlBQVksUUFBYTtRQUxqQixXQUFNLEdBQTJCLEVBQUUsQ0FBQztRQUNwQyxRQUFHLEdBQWUsRUFBRSxDQUFDO1FBQ3JCLGNBQVMsR0FBWSxLQUFLLENBQUM7UUFDM0IsZUFBVSxHQUE0QixJQUFJLGVBQWUsQ0FBUyxDQUFDLENBQUMsQ0FBQztRQUczRSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hCLENBQUM7SUFFTyxNQUFNLENBQUMsUUFBYTtRQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVPLG1CQUFtQjtRQUN6QixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sUUFBUTtRQUNkLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNuQixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcs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RSxDQUFDO1FBQ25CLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQUM3QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB2YWxpZGF0ZSwgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnQHdlYmJsb2Nrc2FwcC9jbGFzcy12YWxpZGF0b3InO1xuaW1wb3J0IHsgVmFsaWRhdG9yT3B0aW9ucyB9IGZyb20gJ0B3ZWJibG9ja3NhcHAvY2xhc3MtdmFsaWRhdG9yJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5leHBvcnQgY2xhc3MgQmFzZU1vZGVsIHtcbiAgcHJpdmF0ZSBkdG9PYmplY3Q6IGFueTtcbiAgcHJpdmF0ZSBlcnJvcnM6IEFycmF5PFZhbGlkYXRpb25FcnJvcj4gPSBbXTtcbiAgcHJpdmF0ZSBtYXA6IEFycmF5PGFueT4gPSBbXTtcbiAgcHJpdmF0ZSBzdWJtaXR0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSByZXNldFRpbWVzOiBCZWhhdmlvclN1YmplY3Q8bnVtYmVyPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8bnVtYmVyPigwKTtcblxuICBjb25zdHJ1Y3RvcihEdG9DbGFzczogYW55KSB7XG4gICAgdGhpcy5zZXREdG8oRHRvQ2xhc3MpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXREdG8oRHRvQ2xhc3M6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuZHRvT2JqZWN0ID0gbmV3IER0b0NsYXNzKCk7XG4gIH1cblxuICBwcml2YXRlIGluY3JlbWVudFJlc2V0VGltZXMoKTogdm9pZCB7XG4gICAgY29uc3QgY3VycmVudFZhbHVlID0gdGhpcy5yZXNldFRpbWVzLmdldFZhbHVlKCk7XG4gICAgdGhpcy5yZXNldFRpbWVzLm5leHQoY3VycmVudFZhbHVlICsgMSk7XG4gIH1cblxuICBwcml2YXRlIHJlc2V0RHRvKCk6IHZvaWQge1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLmR0b09iamVjdCk7XG4gICAga2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIHRoaXMuZHRvT2JqZWN0W2tleV0gPSBudWxsO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldFJlc2V0VGltZXMoKTogQmVoYXZpb3JTdWJqZWN0PG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLnJlc2V0VGltZXM7XG4gIH1cblxuICBwdWJsaWMgZ2V0RHRvKCk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuZHRvT2JqZWN0O1xuICB9XG5cbiAgcHVibGljIHNldFZhbHVlKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5kdG9PYmplY3Rba2V5XSA9IHZhbHVlIHx8IG51bGw7XG4gIH1cblxuICBwdWJsaWMgZ2V0VmFsdWUoa2V5OiBzdHJpbmcpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLmR0b09iamVjdFtrZXldO1xuICB9XG5cbiAgcHVibGljIHNldFN1Ym1pdHRlZChmbGFnOiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5zdWJtaXR0ZWQgPSBmbGFnO1xuICB9XG5cbiAgcHVibGljIGdldFN1Ym1pdHRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zdWJtaXR0ZWQ7XG4gIH1cblxuICBwcml2YXRlIHNldEVycm9ycyhlcnJvcnM6IEFycmF5PFZhbGlkYXRpb25FcnJvcj4pOiB2b2lkIHtcbiAgICB0aGlzLmVycm9ycyA9IE9iamVjdC5hc3NpZ24odGhpcy5lcnJvcnMsIGVycm9ycyk7XG4gIH1cblxuICBwdWJsaWMgaW5pdE1hcCgpOiB2b2lkIHtcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5kdG9PYmplY3QpO1xuXG4gICAga2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGNvbnN0IGZpbHRlcmVkTWFwID0gdGhpcy5tYXAuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnByb3BlcnR5ID09PSBrZXkpO1xuXG4gICAgICBpZiAoZmlsdGVyZWRNYXAubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMubWFwLnB1c2goeyBwcm9wZXJ0eToga2V5LCB0b3VjaGVkOiBmYWxzZSB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzZXRNYXAoKTogdm9pZCB7XG4gICAgdGhpcy5tYXAgPSBbXTtcbiAgICB0aGlzLmluaXRNYXAoKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0VG91Y2hlZChwcm9wZXJ0eTogc3RyaW5nID0gbnVsbCwgdG91Y2hlZDogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcbiAgICBpZiAocHJvcGVydHkpIHtcbiAgICAgIHRoaXMubWFwLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgICBpZiAoaXRlbS5wcm9wZXJ0eSA9PT0gcHJvcGVydHkpIHtcbiAgICAgICAgICBpdGVtLnRvdWNoZWQgPSB0b3VjaGVkO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tYXAubWFwKChpdGVtKSA9PiB7XG4gICAgICAgIGl0ZW0udG91Y2hlZCA9IHRvdWNoZWQ7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNsZWFuRXJyb3IoZmllbGROYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmVycm9ycyA9IHRoaXMuZXJyb3JzLmZpbHRlcigoZXJyb3IpID0+IGVycm9yLnByb3BlcnR5ICE9PSBmaWVsZE5hbWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhbkVycm9ycygpOiB2b2lkIHtcbiAgICB0aGlzLmVycm9ycyA9IFtdO1xuICB9XG5cbiAgcHVibGljIGdldEVycm9ycygpOiBBcnJheTxWYWxpZGF0aW9uRXJyb3I+IHtcbiAgICByZXR1cm4gdGhpcy5lcnJvcnM7XG4gIH1cblxuICBwdWJsaWMgZ2V0TWFwKCk6IEFycmF5PGFueT4ge1xuICAgIHJldHVybiB0aGlzLm1hcDtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQcm9wZXJ0eU1hcChwcm9wZXJ0eSk6IGFueSB7XG4gICAgY29uc3QgZmlsdGVyZWRNYXAgPSB0aGlzLm1hcC5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0ucHJvcGVydHkgPT09IHByb3BlcnR5KTtcblxuICAgIGlmIChmaWx0ZXJlZE1hcC5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm4gZmlsdGVyZWRNYXBbMF07XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwdWJsaWMgZmlsbChkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBvYmplY3RLZXlzID0gT2JqZWN0LmtleXMoZGF0YSk7XG4gICAgb2JqZWN0S2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gZGF0YVtrZXldO1xuICAgICAgdGhpcy5zZXRWYWx1ZShrZXksIHZhbHVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyB2YWxpZGF0ZSh2YWxpZGF0b3JPcHRpb25zPzogVmFsaWRhdG9yT3B0aW9ucyk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICB2YWxpZGF0b3JPcHRpb25zID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAge1xuICAgICAgICAgIHByb3BlcnR5TmFtZTogdW5kZWZpbmVkLFxuICAgICAgICAgIHN0b3BBdEZpcnN0RXJyb3I6IHRydWUsXG4gICAgICAgIH0sXG4gICAgICAgIHZhbGlkYXRvck9wdGlvbnMsXG4gICAgICApO1xuXG4gICAgICB2YWxpZGF0ZSh0aGlzLmR0b09iamVjdCwgdmFsaWRhdG9yT3B0aW9ucykudGhlbigoZXJyb3JzKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5jbGVhbkVycm9ycygpO1xuICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgaXNWYWxpZDogdHJ1ZSxcbiAgICAgICAgICAgIHZhbGlkYXRlZERhdGE6IHRoaXMuZHRvT2JqZWN0LFxuICAgICAgICAgICAgZXJyb3JzOiBudWxsLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhpcy5zZXRFcnJvcnMoZXJyb3JzKTtcbiAgICAgICAgICByZXNvbHZlKHsgaXNWYWxpZDogZmFsc2UsIHZhbGlkYXRlZERhdGE6IG51bGwsIGVycm9ycyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2V0VG91Y2hlZCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgdmFsaWRhdGVGaWVsZChcbiAgICBmaWVsZE5hbWU6IHN0cmluZyxcbiAgICB2YWxpZGF0b3JPcHRpb25zPzogVmFsaWRhdG9yT3B0aW9ucyxcbiAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdmFsaWRhdG9yT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICAgIHtcbiAgICAgICAgICBwcm9wZXJ0eU5hbWU6IGZpZWxkTmFtZSxcbiAgICAgICAgICBzdG9wQXRGaXJzdEVycm9yOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICB2YWxpZGF0b3JPcHRpb25zLFxuICAgICAgKTtcblxuICAgICAgdmFsaWRhdGUodGhpcy5kdG9PYmplY3QsIHZhbGlkYXRvck9wdGlvbnMpLnRoZW4oKGVycm9ycykgPT4ge1xuICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMuY2xlYW5FcnJvcihmaWVsZE5hbWUpO1xuICAgICAgICAgIHJlc29sdmUodGhpcy5kdG9PYmplY3RbZmllbGROYW1lXSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB0aGlzLnNldEVycm9ycyhlcnJvcnMpO1xuICAgICAgICAgIHJlamVjdChlcnJvcnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRUb3VjaGVkKGZpZWxkTmFtZSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyByZXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLmNsZWFuRXJyb3JzKCk7XG4gICAgdGhpcy5zZXRTdWJtaXR0ZWQoZmFsc2UpO1xuICAgIHRoaXMucmVzZXREdG8oKTtcbiAgICB0aGlzLnJlc2V0TWFwKCk7XG4gICAgdGhpcy5pbmNyZW1lbnRSZXNldFRpbWVzKCk7XG4gIH1cbn1cbiJdfQ==